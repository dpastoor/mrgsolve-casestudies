[
["titration-example.html", "titration example 1 Titration Example", " titration example Devin 1 Titration Example library(mrgsolve) #&gt; Loading required package: methods library(tidyverse, warn.conflicts = FALSE) #&gt; Loading tidyverse: ggplot2 #&gt; Loading tidyverse: tibble #&gt; Loading tidyverse: tidyr #&gt; Loading tidyverse: readr #&gt; Loading tidyverse: purrr #&gt; Loading tidyverse: dplyr #&gt; Conflicts with tidy packages ---------------------------------------------- #&gt; filter(): dplyr, stats #&gt; lag(): dplyr, stats Can interactively develop the cpp functions for the needed functionality and check they work as expected. require(Rcpp) #&gt; Loading required package: Rcpp cppFunction(&quot; bool within(Rcpp::NumericVector x, double val) { int n = x.size(); for (int i = 0; i &lt; n; ++i) { if (x[i] == val) { return true; } } return false; } &quot;) within(c(1, 4, 6), 4) #&gt; [1] TRUE within(c(1, 4, 6), 5) #&gt; [1] FALSE cppFunction(&quot; double titrateDose(NumericVector possibleDoses, double currentDose, bool up){ if (up) { possibleDoses = possibleDoses[possibleDoses &gt;= currentDose]; if (possibleDoses.size() &gt; 1) { return possibleDoses[1]; // 2nd element - one dose higher } // at max dose since only one dose remaining that is &gt;= so keep the same return possibleDoses[0]; } else { possibleDoses = possibleDoses[possibleDoses &lt;= currentDose]; if (possibleDoses.size() &gt; 1) { return possibleDoses[possibleDoses.size()-2]; // 2nd to last element - one dose lower } // at min dose since only one dose remaining that is &lt;= so keep the same return possibleDoses[0]; } }&quot;) titrateDose(1:5, 3, up = TRUE) #&gt; [1] 4 titrateDose(1:5, 3, up = FALSE) #&gt; [1] 2 mod1 &lt;- mread_cache(model = &quot;titration&quot;) #&gt; Compiling titration ... #&gt; done. see(mod1) #&gt; #&gt; Model file: titration.cpp #&gt; $PARAM TVCL = 1.3, TVVC=28, TVKA=0.6, WT=70, START_DOSE = 15 #&gt; #&gt; $SET delta= 1 #&gt; #&gt; $CMT GUT CENT #&gt; #&gt; $PLUGIN Rcpp mrgx #&gt; #&gt; $GLOBAL #&gt; using namespace Rcpp; #&gt; NumericVector possibleDoses; #&gt; NumericVector VISITT; #&gt; #&gt; bool within(Rcpp::NumericVector x, double val) { #&gt; int n = x.size(); #&gt; for (int i = 0; i &lt; n; ++i) { #&gt; if (x[i] == val) { #&gt; return true; #&gt; } #&gt; } #&gt; return false; #&gt; } #&gt; double titrateDose(Rcpp::NumericVector possibleDoses, double currentDose, bool up){ #&gt; if (up) { #&gt; possibleDoses = possibleDoses[possibleDoses &gt;= currentDose]; #&gt; if (possibleDoses.size() &gt; 1) { #&gt; return possibleDoses[1]; // 2nd element - one dose higher #&gt; } #&gt; return possibleDoses[0]; // at max dose since only one dose remaining that is &gt;= so keep the same #&gt; } else { #&gt; possibleDoses = possibleDoses[possibleDoses &lt;= currentDose]; #&gt; if (possibleDoses.size() &gt; 1) { #&gt; return possibleDoses[possibleDoses.size()-2]; // 2nd to last element - one dose lower #&gt; } #&gt; return possibleDoses[0]; // at min dose since only one dose remaining that is &lt;= so keep the same #&gt; } #&gt; } #&gt; #&gt; $PREAMBLE #&gt; possibleDoses = mrgx::get&lt;Rcpp::NumericVector&gt;(&quot;possibleDoses&quot;); #&gt; VISITT = mrgx::get&lt;Rcpp::NumericVector&gt;(&quot;VISITT&quot;); #&gt; #&gt; $MAIN #&gt; if (NEWIND &lt;= 1) { #&gt; // titration dose to start on, right now not explicitly checking #&gt; // if in possible doses, probably should do that #&gt; F_GUT = START_DOSE; #&gt; } #&gt; if (within(VISITT, TIME)) { #&gt; // only adjust dose on EVID == 1 or also during observation time can trigger a dose #&gt; // adjustment if both dosing and observing at the same time and not #&gt; // also checking EVID == 1 #&gt; if (CENT &lt; 10 &amp;&amp; EVID == 1) { #&gt; F_GUT = titrateDose(possibleDoses, F_GUT, true); #&gt; } #&gt; if (CENT &gt; 15 &amp;&amp; EVID == 1) { #&gt; F_GUT = titrateDose(possibleDoses, F_GUT, false); #&gt; } #&gt; } #&gt; double CLi = exp(log(TVCL) + 0.75*log(WT/70) + ETA(1)); #&gt; double VCi = exp(log(TVVC) + ETA(2)); #&gt; double KAi = exp(log(TVKA) + ETA(3)); #&gt; #&gt; $OMEGA name=&quot;IIV&quot; #&gt; 0.1 0 0 #&gt; #&gt; $ODE #&gt; dxdt_GUT = -KAi*GUT; #&gt; dxdt_CENT = KAi*GUT - (CLi/VCi)*CENT; #&gt; #&gt; $TABLE #&gt; double CP = CENT/VCi; #&gt; double ETA1 = ETA(1); #&gt; double ETA2 = ETA(2); #&gt; #&gt; $CAPTURE ETA(1) ETA(2) F_GUT possibleDoses &lt;- c(5, 7.5, 10.0, 12.5, 15, 17.5, 20, 30) # times to check and titrate dose accordingly VISITT &lt;- seq(48,300, 48) out &lt;- mod1 %&gt;% data_set(realize_addl(ev(ID=1:9, amt=1, ii=12, addl=24))) %&gt;% env_update(possibleDoses = possibleDoses, VISITT = VISITT) %&gt;% mrgsim(end=12*24) %&gt;% as_data_frame() out %&gt;% ggplot(aes(time, CENT, group=ID, color = factor(ID)))+ geom_line() + facet_wrap(~ID) + theme_bw() Conclusion - starting dose too high, and algorithm not aggressive enough to titrate down. distinct_doses &lt;- out %&gt;% distinct(ID, F_GUT, .keep_all = TRUE) %&gt;% select(ID, time, F_GUT) head(distinct_doses, n = 10) #&gt; # A tibble: 10 x 3 #&gt; ID time F_GUT #&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; #&gt; 1 1 0 15.0 #&gt; 2 1 48 12.5 #&gt; 3 2 0 15.0 #&gt; 4 2 48 12.5 #&gt; 5 2 96 10.0 #&gt; 6 2 144 7.5 #&gt; # ... with 4 more rows # time at which stabilized (final dose first seen) distinct_doses %&gt;% arrange(ID, desc(time)) %&gt;% distinct(ID, .keep_all = T) #&gt; # A tibble: 9 x 3 #&gt; ID time F_GUT #&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; #&gt; 1 1 48 12.5 #&gt; 2 2 144 7.5 #&gt; 3 3 192 5.0 #&gt; 4 4 192 5.0 #&gt; 5 5 144 7.5 #&gt; 6 6 144 7.5 #&gt; # ... with 3 more rows devtools::session_info() #&gt; Session info ------------------------------------------------------------- #&gt; setting value #&gt; version R version 3.4.0 (2017-04-21) #&gt; system x86_64, mingw32 #&gt; ui RTerm #&gt; language (EN) #&gt; collate English_United States.1252 #&gt; tz America/New_York #&gt; date 2017-06-18 #&gt; Packages ----------------------------------------------------------------- #&gt; package * version date source #&gt; assertthat 0.2.0 2017-04-11 CRAN (R 3.4.0) #&gt; backports 1.1.0 2017-05-22 CRAN (R 3.4.0) #&gt; base * 3.4.0 2017-04-21 local #&gt; bookdown 0.4 2017-05-20 CRAN (R 3.4.0) #&gt; broom 0.4.2 2017-02-13 CRAN (R 3.4.0) #&gt; cellranger 1.1.0 2016-07-27 CRAN (R 3.4.0) #&gt; colorspace 1.3-2 2016-12-14 CRAN (R 3.4.0) #&gt; compiler 3.4.0 2017-04-21 local #&gt; datasets * 3.4.0 2017-04-21 local #&gt; devtools 1.13.2 2017-06-02 CRAN (R 3.4.0) #&gt; digest 0.6.12 2017-01-27 CRAN (R 3.4.0) #&gt; dplyr * 0.7.0 2017-06-09 CRAN (R 3.4.0) #&gt; evaluate 0.10 2016-10-11 CRAN (R 3.4.0) #&gt; forcats 0.2.0 2017-01-23 CRAN (R 3.4.0) #&gt; foreign 0.8-67 2016-09-13 CRAN (R 3.4.0) #&gt; ggplot2 * 2.2.1 2016-12-30 CRAN (R 3.4.0) #&gt; glue 1.1.0 2017-06-13 CRAN (R 3.4.0) #&gt; graphics * 3.4.0 2017-04-21 local #&gt; grDevices * 3.4.0 2017-04-21 local #&gt; grid 3.4.0 2017-04-21 local #&gt; gtable 0.2.0 2016-02-26 CRAN (R 3.4.0) #&gt; haven 1.0.0 2016-09-23 CRAN (R 3.4.0) #&gt; hms 0.3 2016-11-22 CRAN (R 3.4.0) #&gt; htmltools 0.3.6 2017-04-28 CRAN (R 3.4.0) #&gt; httr 1.2.1 2016-07-03 CRAN (R 3.4.0) #&gt; jsonlite 1.5 2017-06-01 CRAN (R 3.4.0) #&gt; knitr 1.16 2017-05-18 CRAN (R 3.4.0) #&gt; lattice 0.20-35 2017-03-25 CRAN (R 3.4.0) #&gt; lazyeval 0.2.0 2016-06-12 CRAN (R 3.4.0) #&gt; lubridate 1.6.0 2016-09-13 CRAN (R 3.4.0) #&gt; magrittr 1.5 2014-11-22 CRAN (R 3.4.0) #&gt; memoise 1.1.0 2017-04-21 CRAN (R 3.4.0) #&gt; methods * 3.4.0 2017-04-21 local #&gt; mnormt 1.5-5 2016-10-15 CRAN (R 3.4.0) #&gt; modelr 0.1.0 2016-08-31 CRAN (R 3.4.0) #&gt; mrgsolve * 0.8.6 2017-03-16 CRAN (R 3.4.0) #&gt; munsell 0.4.3 2016-02-13 CRAN (R 3.4.0) #&gt; nlme 3.1-131 2017-02-06 CRAN (R 3.4.0) #&gt; parallel 3.4.0 2017-04-21 local #&gt; plyr 1.8.4 2016-06-08 CRAN (R 3.4.0) #&gt; psych 1.7.5 2017-05-03 CRAN (R 3.4.0) #&gt; purrr * 0.2.2.2 2017-05-11 CRAN (R 3.4.0) #&gt; R6 2.2.1 2017-05-10 CRAN (R 3.4.0) #&gt; Rcpp * 0.12.11 2017-05-22 CRAN (R 3.4.0) #&gt; RcppArmadillo 0.7.900.2.0 2017-06-04 CRAN (R 3.4.0) #&gt; readr * 1.1.1 2017-05-16 CRAN (R 3.4.0) #&gt; readxl 1.0.0 2017-04-18 CRAN (R 3.4.0) #&gt; reshape2 1.4.2 2016-10-22 CRAN (R 3.4.0) #&gt; rlang 0.1.1 2017-05-18 CRAN (R 3.4.0) #&gt; rmarkdown 1.6 2017-06-17 Github (rstudio/rmarkdown@ca634d7) #&gt; rprojroot 1.2 2017-01-16 CRAN (R 3.4.0) #&gt; rvest 0.3.2 2016-06-17 CRAN (R 3.4.0) #&gt; scales 0.4.1 2016-11-09 CRAN (R 3.4.0) #&gt; stats * 3.4.0 2017-04-21 local #&gt; stringi 1.1.5 2017-04-07 CRAN (R 3.4.0) #&gt; stringr 1.2.0 2017-02-18 CRAN (R 3.4.0) #&gt; tibble * 1.3.3 2017-05-28 CRAN (R 3.4.0) #&gt; tidyr * 0.6.3 2017-05-15 CRAN (R 3.4.0) #&gt; tidyverse * 1.1.1 2017-01-27 CRAN (R 3.4.0) #&gt; tools 3.4.0 2017-04-21 local #&gt; utils * 3.4.0 2017-04-21 local #&gt; withr 1.0.2 2016-06-20 CRAN (R 3.4.0) #&gt; xml2 1.1.1 2017-01-24 CRAN (R 3.4.0) #&gt; yaml 2.1.14 2016-11-12 CRAN (R 3.4.0) "]
]
